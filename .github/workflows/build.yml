name: NUC Display CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  workflow_dispatch: # Allow manual trigger

jobs:
  # TIER 1: Fast logic verification on GitHub Cloud
  build_and_test_cloud:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Cache APT Dependencies
      uses: actions/cache@v4
      with:
        path: /var/cache/apt/archives
        key: apt-cache-${{ runner.os }}-v1

    - name: Install Dependencies
      run: |
        sudo rm -f /etc/apt/apt.conf.d/docker-clean
        sudo apt-get update
        sudo apt-get install -y \
          libdrm-dev libgbm-dev libegl1-mesa-dev libgles2-mesa-dev pkg-config \
          libva-dev libavcodec-dev libavformat-dev libswscale-dev libswresample-dev \
          libasound2-dev libfreetype6-dev libharfbuzz-dev libjpeg-dev libpng-dev \
          libcurl4-openssl-dev \
          nlohmann-json3-dev \
          gcovr valgrind ffmpeg

    - name: Configure and Build
      run: |
        cmake -S . -B build -DCMAKE_BUILD_TYPE=Debug
        cmake --build build --config Debug

    - name: Run Logic Tests (Mocks)
      working-directory: build
      run: ctest --output-on-failure

  # TIER 2: Hardware Regression on the NUC
  hardware_regression_nuc:
    runs-on: self-hosted
    needs: build_and_test_cloud
    if: |
      github.repository_owner == 'arunj123' && 
      (github.event_name == 'push' && github.ref == 'refs/heads/master' || github.event_name == 'workflow_dispatch')
    
    steps:
    - uses: actions/checkout@v4

    - name: Pause Production Service
      run: echo arun | sudo -S systemctl stop nuc_display.service || true

    - name: Configure and Build
      run: |
        cmake -S . -B build_hw -DCMAKE_BUILD_TYPE=Debug
        cmake --build build_hw --config Debug

    - name: Run Hardware Tests
      working-directory: build_hw
      run: |
        ./tests/test_video_decoder
        ./tests/test_modules

    - name: Run Memory Leak Checks (Unit Tests)
      working-directory: build_hw
      run: |
        valgrind --leak-check=full --error-exitcode=1 ./tests/test_video_decoder
        valgrind --leak-check=full --error-exitcode=1 ./tests/test_modules

    - name: Run Integration Tests (On-Target)
      working-directory: build_hw
      run: echo arun | sudo -S ./tests/test_integration

    - name: Run Integration Tests (Valgrind)
      working-directory: build_hw
      run: echo arun | sudo -S valgrind --leak-check=full --show-leak-kinds=definite --errors-for-leak-kinds=definite --error-exitcode=1 --trace-children=yes ./tests/test_integration

    - name: Deploy to Production Path
      run: |
        mkdir -p /home/arun/projects/nuc_display/build
        cp build_hw/nuc_display /home/arun/projects/nuc_display/build/nuc_display
        cp config.json /home/arun/projects/nuc_display/config.json
        cp -r assets /home/arun/projects/nuc_display/
        cp nuc_display.service /home/arun/projects/nuc_display/nuc_display.service

    - name: Restart Production Service
      if: always()
      run: echo arun | sudo -S systemctl restart nuc_display.service || true
